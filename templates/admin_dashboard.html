<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BioSecure | Forensic Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            bg: "#020617",       /* Deepest Slate */
            panel: "#0f172a",    /* Slate 900 */
            surface: "#1e293b",  /* Slate 800 */
            border: "#334155",   /* Slate 700 */
            primary: "#0ea5e9",  /* Sky 500 */
            primaryDim: "rgba(14, 165, 233, 0.1)",
            accent: "#6366f1",   /* Indigo 500 */
            success: "#10b981",
            danger: "#ef4444",
            warning: "#f59e0b"
          },
          animation: {
            'scan': 'scan 2.5s linear infinite',
            'fade-in': 'fadeIn 0.3s ease-out forwards',
          },
          keyframes: {
            scan: {
              '0%': { top: '0%', opacity: '0' },
              '15%': { opacity: '1' },
              '85%': { opacity: '1' },
              '100%': { top: '100%', opacity: '0' },
            },
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(5px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          }
        }
      }
    }
  </script>

  <style>
    /* --- CORE LAYOUT FIXES --- */
    body {
      height: 100vh;
      width: 100vw;
      overflow: hidden; /* Prevents whole page scrolling */
    }

    /* Professional Background Pattern */
    .cyber-bg {
      background-color: #020617;
      background-image: 
        linear-gradient(rgba(15, 23, 42, 0.8) 1px, transparent 1px),
        linear-gradient(90deg, rgba(15, 23, 42, 0.8) 1px, transparent 1px);
      background-size: 40px 40px;
    }
    
    .glass-panel {
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* Custom Scrollbar */
    .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #475569; }

    /* Animations & Utilities */
    .nav-item.active {
      background: rgba(14, 165, 233, 0.1);
      color: #38bdf8;
      border-right: 3px solid #38bdf8;
    }
    
    .view-section { display: none; height: 100%; }
    .view-section.active-view { display: block; animation: fadeIn 0.3s ease-out; }

    /* Input Autofill Fix for Dark Mode */
    input:-webkit-autofill,
    input:-webkit-autofill:hover, 
    input:-webkit-autofill:focus, 
    textarea:-webkit-autofill,
    textarea:-webkit-autofill:hover,
    textarea:-webkit-autofill:focus {
      -webkit-text-fill-color: #e2e8f0;
      -webkit-box-shadow: 0 0 0px 1000px #0f172a inset;
      transition: background-color 5000s ease-in-out 0s;
    }
  </style>
</head>

<body class="bg-bg text-slate-300 font-sans flex relative selection:bg-primary/30">

  <div id="mobile-backdrop" class="fixed inset-0 bg-black/80 z-40 hidden md:hidden backdrop-blur-sm" onclick="toggleSidebar()"></div>

  <aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-72 bg-panel/95 border-r border-slate-800 z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col shadow-2xl">
    
    <div class="h-16 flex items-center px-6 border-b border-slate-800 bg-black/20">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-blue-600 mr-3 flex items-center justify-center text-white font-bold text-sm shadow-[0_0_15px_rgba(14,165,233,0.3)]">B</div>
      <div>
        <h1 class="font-bold text-white tracking-wide text-lg">Bio<span class="text-primary">Secure</span></h1>
        <p class="text-[10px] text-slate-500 font-mono tracking-widest uppercase">Forensic Suite v2.0</p>
      </div>
    </div>

    <nav class="flex-grow p-4 space-y-1 overflow-y-auto custom-scroll">
      
      <div class="px-3 mb-2 mt-2">
        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Operations</span>
      </div>

      <button onclick="switchView('enrollment')" id="nav-enrollment" class="nav-item active w-full flex items-center gap-3 px-3 py-3 rounded-md text-sm font-medium hover:bg-slate-800 hover:text-white transition group text-left">
        <i data-lucide="scan-face" class="w-4 h-4 text-slate-400 group-hover:text-primary transition"></i>
        Enrollment Station
      </button>

      <button onclick="switchView('database')" id="nav-database" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-md text-sm font-medium hover:bg-slate-800 hover:text-white transition group text-left">
        <i data-lucide="database" class="w-4 h-4 text-slate-400 group-hover:text-primary transition"></i>
        Identity Database
      </button>

      <div class="px-3 mb-2 mt-6">
        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Administration</span>
      </div>

      <button onclick="switchView('sensor')" id="nav-sensor" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-md text-sm font-medium hover:bg-slate-800 hover:text-white transition group text-left">
        <i data-lucide="settings-2" class="w-4 h-4 text-slate-400 group-hover:text-primary transition"></i>
        Hardware Config
      </button>

      <button onclick="switchView('audit')" id="nav-audit" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-md text-sm font-medium hover:bg-slate-800 hover:text-white transition group text-left">
        <i data-lucide="shield-alert" class="w-4 h-4 text-slate-400 group-hover:text-primary transition"></i>
        Security Audit
      </button>

    </nav>

    <div class="p-4 bg-slate-900/50 border-t border-slate-800">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center border border-slate-600 relative">
          <span class="text-sm font-bold text-white">{{ user[0]|upper }}</span>
          <span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-emerald-500 border-2 border-slate-900 rounded-full"></span>
        </div>
        <div class="overflow-hidden">
          <p class="text-sm font-semibold text-white truncate">{{ user }}</p>
          <p class="text-[10px] text-slate-500 font-mono">ID: {{ admin_id }}</p>
        </div>
      </div>
      <a href="/logout" class="flex items-center justify-center gap-2 w-full py-2 bg-slate-800 hover:bg-red-900/20 border border-slate-700 hover:border-red-500/30 text-slate-300 hover:text-red-400 rounded-lg text-xs font-medium transition">
        <i data-lucide="log-out" class="w-3 h-3"></i> Secure Logout
      </a>
    </div>
  </aside>

  <main class="flex-1 flex flex-col h-full relative cyber-bg overflow-hidden">
    
    <header class="h-16 flex-none bg-panel/80 backdrop-blur-md border-b border-slate-800 flex justify-between items-center px-6 z-20">
      <div class="flex items-center gap-4">
        <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-400 hover:text-white">
          <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        
        <h2 id="pageTitle" class="text-lg font-semibold text-white flex items-center gap-3">
          <div class="p-1.5 rounded bg-primary/10 text-primary"><i data-lucide="scan-face" class="w-5 h-5"></i></div>
          Enrollment Station
        </h2>
      </div>

      <div class="flex items-center gap-4">
        <div class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800/50 border border-slate-700">
          <div class="flex gap-1">
             <span class="w-1 h-3 bg-emerald-500 rounded-full animate-pulse"></span>
             <span class="w-1 h-3 bg-emerald-500 rounded-full animate-pulse delay-75"></span>
             <span class="w-1 h-3 bg-emerald-500 rounded-full animate-pulse delay-150"></span>
          </div>
          <span class="text-[10px] font-mono text-emerald-400 font-bold tracking-wider">SYSTEM ONLINE</span>
        </div>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 relative">
      
      <div id="view-enrollment" class="view-section active-view max-w-7xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
          
          <div class="lg:col-span-8 space-y-6">
             
             <div class="glass-panel rounded-xl p-6 shadow-xl">
                <div class="flex items-center justify-between mb-6 border-b border-slate-700/50 pb-4">
                  <h3 class="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="user" class="w-4 h-4 text-primary"></i> Subject Biography
                  </h3>
                  <span class="text-[10px] text-slate-500 bg-slate-800 px-2 py-1 rounded border border-slate-700">STEP 1/3</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                   <div class="col-span-1 md:col-span-2">
                      <label class="block text-xs font-medium text-slate-400 mb-1.5">Full Legal Name</label>
                      <div class="relative group">
                        <i data-lucide="type" class="absolute left-3 top-3 w-4 h-4 text-slate-500 group-focus-within:text-primary transition"></i>
                        <input type="text" id="name" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg py-2.5 pl-10 pr-4 text-sm text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary/50 transition placeholder:text-slate-600" placeholder="Enter subject name">
                      </div>
                   </div>

                   <div>
                      <label class="block text-xs font-medium text-slate-400 mb-1.5">Case Reference ID</label>
                      <input type="text" id="caseId" readonly class="w-full bg-slate-900/30 border border-slate-700 rounded-lg py-2.5 px-3 text-sm font-mono text-slate-400 cursor-not-allowed">
                   </div>

                   <div>
                      <label class="block text-xs font-medium text-slate-400 mb-1.5">Authorization Level</label>
                      <select class="w-full bg-slate-900/50 border border-slate-700 rounded-lg py-2.5 px-3 text-sm text-white focus:outline-none focus:border-primary">
                        <option>Standard Civilian</option>
                        <option>Criminal Record</option>
                        <option>High Security</option>
                      </select>
                   </div>
                   
                   <div class="col-span-1 md:col-span-2">
                      <label class="block text-xs font-medium text-slate-400 mb-1.5">Physical Remarks / Notes</label>
                      <textarea id="notes" rows="2" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg py-2 px-3 text-sm text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary/50 transition placeholder:text-slate-600" placeholder="Scars, tattoos, or other identifying marks..."></textarea>
                   </div>
                </div>
             </div>

             <div class="glass-panel rounded-xl p-6 shadow-xl">
                <div class="flex items-center justify-between mb-6 border-b border-slate-700/50 pb-4">
                  <h3 class="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="fingerprint" class="w-4 h-4 text-primary"></i> Biometric Metadata
                  </h3>
                  <span class="text-[10px] text-slate-500 bg-slate-800 px-2 py-1 rounded border border-slate-700">STEP 2/3</span>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                   <div>
                      <label class="text-[10px] uppercase font-bold text-slate-500">Hand</label>
                      <select id="hand" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white focus:border-primary focus:outline-none">
                        <option value="Right">Right</option>
                        <option value="Left">Left</option>
                      </select>
                   </div>
                   <div>
                      <label class="text-[10px] uppercase font-bold text-slate-500">Finger</label>
                      <select id="finger" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white focus:border-primary focus:outline-none">
                        <option value="Thumb">Thumb</option>
                        <option value="Index">Index</option>
                        <option value="Middle">Middle</option>
                        <option value="Ring">Ring</option>
                        <option value="Little">Little</option>
                      </select>
                   </div>
                   <div>
                      <label class="text-[10px] uppercase font-bold text-slate-500">Pattern</label>
                      <select id="pattern" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white focus:border-primary focus:outline-none">
                        <option value="Unknown">Auto-Detect</option>
                        <option value="Loop">Loop</option>
                        <option value="Whorl">Whorl</option>
                        <option value="Arch">Arch</option>
                      </select>
                   </div>
                   <div>
                      <label class="text-[10px] uppercase font-bold text-slate-500">Sensor</label>
                      <input type="text" value="OPT-500" disabled class="mt-1 w-full bg-black/40 border border-slate-700 rounded p-2 text-sm text-slate-500 font-mono text-center">
                   </div>
                </div>
             </div>

             <div class="flex flex-col sm:flex-row gap-4 pt-2">
                <button id="resetBtn" class="sm:w-1/3 py-3 rounded-lg border border-slate-700 text-slate-400 hover:bg-slate-800 hover:text-white transition font-medium text-sm flex items-center justify-center gap-2">
                  <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Reset Form
                </button>
                <button id="submitBtn" class="sm:w-2/3 py-3 rounded-lg bg-primary hover:bg-sky-400 text-white font-bold shadow-[0_0_20px_rgba(14,165,233,0.3)] hover:shadow-[0_0_30px_rgba(14,165,233,0.5)] transition-all duration-300 flex items-center justify-center gap-2 relative overflow-hidden group">
                  <span class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700 ease-in-out"></span>
                  <i data-lucide="save" class="w-4 h-4"></i> <span id="btnText">Securely Enroll Subject</span>
                </button>
             </div>
             
             <div id="statusBox" class="hidden rounded-lg p-4 border text-sm flex items-center gap-3 animate-fade-in shadow-lg"></div>

          </div>

          <div class="lg:col-span-4 flex flex-col gap-6">
             
             <div class="glass-panel border-dashed border-2 border-slate-700 rounded-xl aspect-[3/4] relative group overflow-hidden flex flex-col items-center justify-center cursor-pointer hover:border-primary/50 transition-colors duration-300" id="dropZone">
                <input type="file" id="imageInput" accept="image/*" class="hidden" />
                
                <div id="uploadPlaceholder" class="text-center p-6 transition-transform duration-300 group-hover:scale-105">
                   <div class="w-20 h-20 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center mx-auto mb-5 shadow-2xl group-hover:shadow-primary/20 group-hover:border-primary/50 transition">
                      <i data-lucide="upload-cloud" class="w-8 h-8 text-slate-500 group-hover:text-primary transition"></i>
                   </div>
                   <p class="text-sm font-bold text-white tracking-wide">Upload Fingerprint</p>
                   <p class="text-xs text-slate-500 mt-2">Drag & drop or click to browse</p>
                   <div class="mt-4 inline-block px-3 py-1 bg-black/40 rounded border border-slate-800 text-[10px] text-slate-400 font-mono">
                      FMT: PNG, JPG, BMP
                   </div>
                </div>

                <img id="imagePreview" class="absolute inset-0 w-full h-full object-contain bg-black hidden z-10 p-4" />
                
                <div id="scanOverlay" class="absolute inset-0 bg-primary/10 hidden z-20 pointer-events-none backdrop-blur-[2px]">
                   <div class="absolute top-0 left-0 w-full h-1 bg-primary shadow-[0_0_20px_#38bdf8] animate-scan opacity-80"></div>
                   <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex items-center gap-2 px-4 py-2 bg-black/80 rounded border border-primary/30 shadow-lg">
                      <i data-lucide="loader-2" class="w-3 h-3 text-primary animate-spin"></i>
                      <span class="text-[10px] font-mono text-primary font-bold tracking-widest">VECTORIZING...</span>
                   </div>
                   <div class="absolute inset-0 bg-[linear-gradient(rgba(14,165,233,0.1)_1px,transparent_1px),linear-gradient(90deg,rgba(14,165,233,0.1)_1px,transparent_1px)] bg-[size:20px_20px]"></div>
                </div>
             </div>

             <div class="glass-panel rounded-xl p-5 shadow-lg">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-4 flex justify-between items-center">
                  Quality Matrix <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                </h4>
                <div class="space-y-4">
                  <div>
                    <div class="flex justify-between text-xs mb-1">
                      <span class="text-slate-300 font-medium">Ridge Clarity</span>
                      <span id="score-clarity" class="text-emerald-400 font-mono">0%</span>
                    </div>
                    <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden">
                      <div id="bar-clarity" class="bg-emerald-500 h-full w-[0%] transition-all duration-1000 ease-out shadow-[0_0_8px_rgba(16,185,129,0.8)]"></div>
                    </div>
                  </div>
                  <div>
                    <div class="flex justify-between text-xs mb-1">
                      <span class="text-slate-300 font-medium">Contrast Level</span>
                      <span id="score-contrast" class="text-primary font-mono">0%</span>
                    </div>
                    <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden">
                      <div id="bar-contrast" class="bg-primary h-full w-[0%] transition-all duration-1000 ease-out delay-100 shadow-[0_0_8px_rgba(14,165,233,0.8)]"></div>
                    </div>
                  </div>
                </div>
             </div>

          </div>
        </div>
      </div>

      <div id="view-database" class="view-section max-w-7xl mx-auto h-full flex flex-col">
         <div class="glass-panel border border-slate-800 rounded-xl overflow-hidden shadow-2xl flex flex-col max-h-[calc(100vh-140px)]">
            
            <div class="p-4 border-b border-slate-800 flex flex-col sm:flex-row justify-between items-center gap-4 bg-slate-900/50">
               <div class="flex items-center gap-3">
                  <div class="p-2 bg-primary/10 rounded-lg text-primary"><i data-lucide="database" class="w-5 h-5"></i></div>
                  <h3 class="text-sm font-bold text-white uppercase tracking-wider">Registered Identities</h3>
               </div>
               <div class="flex w-full sm:w-auto gap-2">
                  <div class="relative flex-grow sm:flex-grow-0">
                     <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-500"></i>
                     <input type="text" placeholder="Search ID..." class="w-full sm:w-64 bg-slate-950 border border-slate-700 rounded-lg pl-9 pr-3 py-2 text-xs text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary/30">
                  </div>
                  <button onclick="fetchDatabase()" class="p-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-slate-300 hover:text-white transition tooltip" title="Refresh">
                     <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                  </button>
               </div>
            </div>
            
            <div class="flex-grow overflow-auto custom-scroll bg-slate-900/30">
               <table class="w-full text-left text-sm text-slate-400">
                  <thead class="bg-slate-900 text-xs uppercase font-bold text-slate-300 sticky top-0 z-10 shadow-lg">
                     <tr>
                        <th class="px-6 py-4 bg-slate-900 border-b border-slate-800">Identity Profile</th>
                        <th class="px-6 py-4 bg-slate-900 border-b border-slate-800">Biometric Data</th>
                        <th class="px-6 py-4 bg-slate-900 border-b border-slate-800">Metadata</th>
                        <th class="px-6 py-4 bg-slate-900 border-b border-slate-800">Timestamp</th>
                        <th class="px-6 py-4 bg-slate-900 border-b border-slate-800 text-right">Control</th>
                     </tr>
                  </thead>
                  <tbody id="dbTableBody" class="divide-y divide-slate-800/50">
                     </tbody>
               </table>
            </div>
            
            <div class="p-2 border-t border-slate-800 bg-slate-900/80 text-center">
               <span class="text-[10px] text-slate-500 font-mono">SECURE CONNECTION ESTABLISHED â€¢ END OF RECORDS</span>
            </div>
         </div>
      </div>
      
      <div id="view-sensor" class="view-section max-w-4xl mx-auto">
         <div class="glass-panel border border-slate-800 rounded-xl p-8 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-3 pb-4 border-b border-slate-800">
               <i data-lucide="cpu" class="w-6 h-6 text-primary"></i> Sensor Calibration
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
               <div class="bg-slate-900/60 border border-primary/30 rounded-xl p-6 relative overflow-hidden group">
                  <div class="absolute top-0 right-0 p-3">
                     <div class="flex items-center gap-2 px-2 py-1 bg-emerald-500/10 rounded border border-emerald-500/20">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span class="text-[10px] text-emerald-500 font-bold">ACTIVE</span>
                     </div>
                  </div>
                  <div class="w-12 h-12 rounded bg-slate-800 flex items-center justify-center mb-4 border border-slate-700 text-primary">
                     <i data-lucide="fingerprint" class="w-6 h-6"></i>
                  </div>
                  <h4 class="text-white font-bold text-lg">Optical Sensor 1</h4>
                  <p class="text-xs text-slate-500 mb-6 font-mono">HW-ID: OPT-500-A22</p>
                  
                  <div class="space-y-5">
                     <div>
                        <div class="flex justify-between text-xs mb-2 text-slate-400"><span>Resolution (DPI)</span> <span>500</span></div>
                        <input type="range" class="w-full accent-primary h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer" value="80">
                     </div>
                     <div>
                        <div class="flex justify-between text-xs mb-2 text-slate-400"><span>Gain / Contrast</span> <span>85%</span></div>
                        <input type="range" class="w-full accent-primary h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer" value="85">
                     </div>
                  </div>
                  <button class="mt-8 w-full py-2 bg-slate-800 hover:bg-primary/20 hover:text-primary border border-slate-700 hover:border-primary/50 text-slate-300 text-xs font-bold rounded transition uppercase tracking-wider">
                     Run Diagnostics
                  </button>
               </div>
               
               <div class="bg-slate-900/30 border border-dashed border-slate-700 rounded-xl p-6 flex flex-col items-center justify-center opacity-70 hover:opacity-100 transition">
                  <i data-lucide="plug-zap" class="w-10 h-10 text-slate-600 mb-3"></i>
                  <h4 class="text-slate-400 font-bold">Secondary Input</h4>
                  <p class="text-xs text-slate-600 mb-4">No device detected</p>
                  <button class="px-4 py-2 bg-transparent border border-slate-700 rounded text-xs text-slate-500 hover:text-white hover:border-slate-500 transition">Scan Ports</button>
               </div>
            </div>
         </div>
      </div>

      <div id="view-audit" class="view-section max-w-5xl mx-auto">
         <div class="glass-panel border border-slate-800 rounded-xl p-6 shadow-2xl h-full flex flex-col">
            <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-3">
               <i data-lucide="terminal" class="w-5 h-5 text-warning"></i> System Audit Trail
            </h3>
            <div class="bg-black/40 border border-slate-800 rounded-lg p-4 font-mono text-xs overflow-y-auto custom-scroll max-h-[600px]" id="auditLogContainer">
               <div class="flex gap-4 mb-2 border-b border-slate-800/50 pb-2">
                  <span class="text-slate-500 w-24">10:41:02</span>
                  <span class="text-emerald-500 font-bold w-20">AUTH</span>
                  <span class="text-slate-300">Administrator session initialized [IP: 192.168.1.10]</span>
               </div>
               <div class="flex gap-4 mb-2 border-b border-slate-800/50 pb-2">
                  <span class="text-slate-500 w-24">10:41:05</span>
                  <span class="text-blue-500 font-bold w-20">SYSTEM</span>
                  <span class="text-slate-300">Database integrity check passed.</span>
               </div>
            </div>
         </div>
      </div>

    </div>
    <footer class="w-full py-6 mt-12 border-t border-slate-800 bg-slate-950/50 backdrop-blur-sm text-center">
    <p class="text-slate-500 text-sm font-mono">
        &copy; 2026 BioSecure Forensic System. All Rights Reserved.
        <span class="hidden md:inline mx-2 text-slate-700">|</span>
        <br class="md:hidden">
        Developed by 
        <a href="https://deva-portfolio-app.netlify.app/" 
           target="_blank" 
           rel="noopener noreferrer"
           class="text-emerald-400 hover:text-emerald-300 transition-colors font-bold tracking-wide hover:underline decoration-emerald-500/50 underline-offset-4">
            Deva Veera Kumaran
        </a>
    </p>
</footer>
  </main>

  <script>
    lucide.createIcons();
    const caseIdField = document.getElementById('caseId');
    const dbTableBody = document.getElementById("dbTableBody");
    const auditContainer = document.getElementById("auditLogContainer");
    
    // Generate Random Case ID
    function generateCaseID() {
      caseIdField.value = "CR-" + new Date().getFullYear() + "-" + Math.floor(1000 + Math.random() * 9000);
    }
    generateCaseID();

    // --- NAVIGATION LOGIC ---
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const backdrop = document.getElementById('mobile-backdrop');
      sidebar.classList.toggle('-translate-x-full');
      backdrop.classList.toggle('hidden');
    }

    function switchView(viewName) {
      // Toggle Sidebar on mobile if open
      const sidebar = document.getElementById('sidebar');
      if (!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 768) {
         toggleSidebar();
      }

      // Hide all views
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      
      // Show selected
      document.getElementById(`view-${viewName}`).classList.add('active-view');
      document.getElementById(`nav-${viewName}`).classList.add('active');
      
      // Update Header Text & Icon
      const titles = {
        'enrollment': { text: 'Enrollment Station', icon: 'scan-face' },
        'database': { text: 'Identity Database', icon: 'database' },
        'sensor': { text: 'Sensor Configuration', icon: 'settings-2' },
        'audit': { text: 'Security Audit', icon: 'shield-alert' }
      };
      const info = titles[viewName];
      document.getElementById('pageTitle').innerHTML = `
         <div class="p-1.5 rounded bg-primary/10 text-primary"><i data-lucide="${info.icon}" class="w-5 h-5"></i></div>
         ${info.text}
      `;
      lucide.createIcons();

      if(viewName === 'database') fetchDatabase();
    }

    // --- ENROLLMENT LOGIC ---
    const dropZone = document.getElementById('dropZone');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const scanOverlay = document.getElementById('scanOverlay');

    dropZone.addEventListener('click', () => imageInput.click());
    
    // Drag and Drop Effects
    dropZone.addEventListener('dragover', (e) => {
       e.preventDefault();
       dropZone.classList.add('border-primary');
    });
    dropZone.addEventListener('dragleave', (e) => {
       e.preventDefault();
       dropZone.classList.remove('border-primary');
    });
    dropZone.addEventListener('drop', (e) => {
       e.preventDefault();
       dropZone.classList.remove('border-primary');
       const files = e.dataTransfer.files;
       if(files.length) handleFile(files[0]);
    });

    imageInput.addEventListener('change', (e) => {
      if (e.target.files[0]) handleFile(e.target.files[0]);
    });

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = (evt) => {
        imagePreview.src = evt.target.result;
        imagePreview.classList.remove('hidden');
        uploadPlaceholder.classList.add('hidden');
        simulateScan();
      };
      reader.readAsDataURL(file);
    }

    function simulateScan() {
       // Reset bars
       document.getElementById('bar-clarity').style.width = '0%';
       document.getElementById('bar-contrast').style.width = '0%';
       
       // Random Scores
       const clarity = Math.floor(Math.random() * 15) + 85; // 85-99
       const contrast = Math.floor(Math.random() * 20) + 70; // 70-90
       
       setTimeout(() => {
          document.getElementById('bar-clarity').style.width = `${clarity}%`;
          document.getElementById('score-clarity').innerText = `${clarity}%`;
       }, 200);
       setTimeout(() => {
          document.getElementById('bar-contrast').style.width = `${contrast}%`;
          document.getElementById('score-contrast').innerText = `${contrast}%`;
       }, 500);
    }

    // --- SUBMIT LOGIC ---
    document.getElementById("submitBtn").addEventListener("click", async () => {
      const name = document.getElementById("name").value;
      const file = imageInput.files[0] || (imagePreview.src.startsWith('data') ? dataURLtoFile(imagePreview.src, 'upload.png') : null);
      const statusBox = document.getElementById("statusBox");
      const btn = document.getElementById("submitBtn");
      
      if (!name || !imagePreview.src || imagePreview.classList.contains('hidden')) {
         showStatus(false, "Subject Name and Fingerprint Image are mandatory.");
         return;
      }

      // UI Loading
      btn.disabled = true;
      document.getElementById("btnText").innerText = "Encrypting...";
      scanOverlay.classList.remove("hidden");
      statusBox.classList.add("hidden");

      const formData = new FormData();
      formData.append("name", name);
      formData.append("hand", document.getElementById("hand").value);
      formData.append("finger", document.getElementById("finger").value);
      formData.append("notes", document.getElementById("notes").value);
      // If using file input, use that. If drag/drop logic needs file object, ensure it's there.
      // For simplicity assuming file input has the file:
      if(imageInput.files[0]) formData.append("image", imageInput.files[0]);
      
      try {
         const res = await fetch("/api/enroll", { method: "POST", body: formData });
         const data = await res.json();
         
         scanOverlay.classList.add("hidden");
         
         if(data.success) {
            showStatus(true, `Subject ${name} successfully enrolled.`);
            logAudit("ENROLL", `Added subject ${name} (${document.getElementById("caseId").value})`);
            
            setTimeout(() => {
               // Reset
               document.getElementById("name").value = "";
               document.getElementById("notes").value = "";
               generateCaseID();
               imagePreview.classList.add("hidden");
               uploadPlaceholder.classList.remove("hidden");
               statusBox.classList.add("hidden");
               document.getElementById('bar-clarity').style.width = '0%';
               document.getElementById('bar-contrast').style.width = '0%';
               document.getElementById("score-clarity").innerText = "0%";
               document.getElementById("score-contrast").innerText = "0%";
            }, 2500);
         } else {
            throw new Error(data.message);
         }
      } catch(err) {
         showStatus(false, "Transmission Error: " + err.message);
      } finally {
         btn.disabled = false;
         document.getElementById("btnText").innerText = "Securely Enroll Subject";
      }
    });

    function showStatus(success, msg) {
       const box = document.getElementById("statusBox");
       box.classList.remove("hidden");
       if(success) {
          box.className = "rounded-lg p-4 border text-sm flex items-center gap-3 animate-fade-in shadow-lg bg-emerald-500/10 border-emerald-500/20 text-emerald-400";
          box.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5"></i> <div><span class="font-bold">Success:</span> ${msg}</div>`;
       } else {
          box.className = "rounded-lg p-4 border text-sm flex items-center gap-3 animate-fade-in shadow-lg bg-red-500/10 border-red-500/20 text-red-400";
          box.innerHTML = `<i data-lucide="alert-triangle" class="w-5 h-5"></i> <div><span class="font-bold">Error:</span> ${msg}</div>`;
       }
       lucide.createIcons();
    }

    // --- DATABASE TABLE ---
    async function fetchDatabase() {
       dbTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-12 text-slate-500"><i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2 text-primary"></i>Retrieving Secure Records...</td></tr>`;
       lucide.createIcons();
       
       try {
          const res = await fetch("/api/prints");
          const data = await res.json();
          dbTableBody.innerHTML = "";

          if(!data.data || data.data.length === 0) {
             dbTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-12 text-slate-500">Database is empty.</td></tr>`;
             return;
          }

          data.data.forEach(item => {
             const row = `
               <tr class="group hover:bg-slate-800/50 transition border-b border-slate-800/50">
                  <td class="px-6 py-4">
                     <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-xs font-bold text-white border border-slate-600">
                           ${item.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                           <div class="font-medium text-white text-sm">${item.name}</div>
                           <div class="text-[10px] text-slate-500 font-mono">REF: ${item._id.substring(18)}</div>
                        </div>
                     </div>
                  </td>
                  <td class="px-6 py-4">
                     <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-slate-800 border border-slate-700 text-xs text-slate-300">
                        <i data-lucide="fingerprint" class="w-3 h-3"></i> ${item.hand || '?'} / ${item.finger || '?'}
                     </span>
                  </td>
                  <td class="px-6 py-4 max-w-xs truncate text-xs text-slate-500 italic">
                     ${item.notes || 'No remarks'}
                  </td>
                  <td class="px-6 py-4 text-xs font-mono text-slate-500">
                     ${new Date(item.created_at).toLocaleString()}
                  </td>
                  <td class="px-6 py-4 text-right">
                     <button onclick="deleteRecord('${item._id}')" class="p-2 text-slate-500 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition" title="Delete Record">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                     </button>
                  </td>
               </tr>
             `;
             dbTableBody.innerHTML += row;
          });
          lucide.createIcons();
       } catch(err) {
          dbTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-12 text-red-500">Connection Failed</td></tr>`;
       }
    }

    async function deleteRecord(id) {
       if(!confirm("WARNING: This action is permanent. Delete biometric record?")) return;
       await fetch(`/api/prints/${id}`, { method: "DELETE" });
       logAudit("DELETE", `Removed record ID ending in ...${id.substring(18)}`);
       fetchDatabase();
    }

    // --- AUDIT LOG ---
    function logAudit(type, message) {
       const time = new Date().toLocaleTimeString('en-US', { hour12: false });
       let color = "text-slate-300";
       if(type === "ENROLL") color = "text-emerald-500 font-bold";
       if(type === "DELETE") color = "text-red-500 font-bold";

       const entry = `
         <div class="flex gap-4 mb-2 border-b border-slate-800/50 pb-2 animate-fade-in">
            <span class="text-slate-500 w-24">${time}</span>
            <span class="${color} w-20">${type}</span>
            <span class="text-slate-300 flex-1">${message}</span>
         </div>
       `;
       auditContainer.innerHTML = entry + auditContainer.innerHTML;
    }

    // Helper for drag/drop (simplified)
    function dataURLtoFile(dataurl, filename) {
        let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
        while(n--){ u8arr[n] = bstr.charCodeAt(n); }
        return new File([u8arr], filename, {type:mime});
    }
  </script>
</body>
</html>